<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Demonstra√ß√£o CSRF - Double Submit Cookie</title>
    <style>
      body { 
        font-family: Arial, sans-serif; 
        margin: 20px; 
        background-color: #f5f5f5; 
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .section { 
        margin: 20px 0; 
        padding: 15px; 
        border: 1px solid #ddd; 
        border-radius: 5px;
        background: #fafafa;
      }
      .success { color: #28a745; font-weight: bold; }
      .error { color: #dc3545; font-weight: bold; }
      .info { color: #17a2b8; }
      .warning { color: #ffc107; }
      button { 
        margin: 5px; 
        padding: 10px 15px; 
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }
      .btn-primary { background: #007bff; color: white; }
      .btn-success { background: #28a745; color: white; }
      .btn-warning { background: #ffc107; color: black; }
      .btn-danger { background: #dc3545; color: white; }
      input[type="text"], input[type="password"] {
        padding: 8px;
        margin: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 200px;
      }
      .token-display {
        background: #e9ecef;
        padding: 10px;
        border-radius: 4px;
        font-family: monospace;
        word-break: break-all;
        margin: 10px 0;
      }
      .step-number {
        background: #007bff;
        color: white;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
        font-weight: bold;
      }
      h2 { 
        display: flex; 
        align-items: center;
        color: #333;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîí Demonstra√ß√£o: Prote√ß√£o CSRF com Double Submit Cookie</h1>
      <p><strong>Biblioteca:</strong> <code>csrf-csrf</code> | <strong>Padr√£o:</strong> Double Submit Cookie</p>
      
      <div class="section">
        <h2><span class="step-number">1</span>Login (Gerar Tokens CSRF)</h2>
        <p>O servidor gera um token CSRF e o envia de <strong>duas formas</strong>:</p>
        <ul>
          <li>üç™ Como cookie <code>XSRF-TOKEN</code> (acess√≠vel via JavaScript)</li>
          <li>üìÑ Como token vis√≠vel na resposta JSON</li>
        </ul>
        <form id="login-form">
          <label>Usu√°rio: <input type="text" id="username" value="ana" /></label><br><br>
          <label>Senha: <input type="password" id="password" value="123" /></label><br><br>
          <button type="submit" class="btn-primary">üöÄ Fazer Login</button>
        </form>
        <div id="login-status"></div>
      </div>

      <div class="section">
        <h2><span class="step-number">2</span>Estado Atual dos Tokens CSRF</h2>
        <p>Verificar se os tokens foram criados corretamente:</p>
        <button onclick="checkTokens()" class="btn-success">üîç Verificar Tokens</button>
        <div id="token-status"></div>
      </div>

      <div class="section">
        <h2><span class="step-number">3</span>Alterar Senha (COM Prote√ß√£o CSRF)</h2>
        <p>O cliente envia o token no cabe√ßalho <code>x-csrf-token</code>:</p>
        <form id="change-password-form">
          <label>Nova Senha: <input type="password" id="new-password" value="novaSenha123" /></label><br><br>
          <button type="submit" class="btn-success">üîê Alterar Senha (Protegido)</button>
        </form>
        <div id="change-status"></div>
      </div>

      <div class="section">
        <h2><span class="step-number">4</span>Adicionar Contato (COM Prote√ß√£o CSRF)</h2>
        <p>Testar a rota <code>/contact</code> agora protegida:</p>
        <form id="contact-form">
          <label>Nome: <input type="text" id="contact-name" value="Jo√£o Silva" /></label><br>
          <label>Telefone: <input type="text" id="contact-phone" value="11999887766" /></label><br><br>
          <button type="submit" class="btn-success">üì± Adicionar Contato (Protegido)</button>
        </form>
        <div id="contact-status"></div>
      </div>

      <div class="section">
        <h2><span class="step-number">5</span>Teste de Ataque CSRF</h2>
        <p>Simular ataque <strong>sem</strong> enviar o token CSRF:</p>
        <button onclick="testAttackPassword()" class="btn-danger">‚ö†Ô∏è Atacar Mudan√ßa de Senha</button>
        <button onclick="testAttackContact()" class="btn-danger">‚ö†Ô∏è Atacar Adi√ß√£o de Contato</button>
        <div id="attack-status"></div>
      </div>

      <div class="section">
        <h2>üìö Como Funciona o Double Submit Cookie</h2>
        <ol>
          <li><strong>Servidor gera token:</strong> Cria um token √∫nico e seguro</li>
          <li><strong>Envia de duas formas:</strong> Cookie + JSON/HTML</li>
          <li><strong>Cliente armazena:</strong> Token dispon√≠vel via JavaScript</li>
          <li><strong>Cliente envia:</strong> Token no cabe√ßalho <code>x-csrf-token</code></li>
          <li><strong>Servidor valida:</strong> Compara cookie com cabe√ßalho</li>
          <li><strong>Resultado:</strong> Aceita se forem iguais, rejeita se diferentes</li>
        </ol>
      </div>
    </div>

    <script>
      // Fun√ß√£o para obter token CSRF do cookie
      function getCsrfToken() {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
          const [name, value] = cookie.trim().split('=');
          if (name === 'XSRF-TOKEN') {
            return decodeURIComponent(value);
          }
        }
        return null;
      }

      // Fun√ß√£o para verificar estado dos tokens
      function checkTokens() {
        const csrfToken = getCsrfToken();
        const tokenStatus = document.getElementById('token-status');
        
        if (csrfToken) {
          tokenStatus.innerHTML = `
            <div class="success">‚úÖ Cookie XSRF-TOKEN encontrado!</div>
            <div class="token-display">
              <strong>Token:</strong> ${csrfToken}
            </div>
            <div class="info">
              ‚úì Este token ser√° enviado no cabe√ßalho <code>x-csrf-token</code><br>
              ‚úì O servidor comparar√° com o valor do cookie<br>
              ‚úì Se forem iguais, a requisi√ß√£o ser√° aceita
            </div>
          `;
        } else {
          tokenStatus.innerHTML = '<div class="error">‚ùå Token CSRF n√£o encontrado. Fa√ßa login primeiro.</div>';
        }
      }

      // 1. LOGIN - Gerar tokens CSRF
      document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const status = document.getElementById('login-status');

        try {
          const response = await fetch('/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include', // IMPORTANTE: Para cookies
            body: JSON.stringify({ username, password })
          });

          const data = await response.json();
          
          if (response.ok) {
            status.innerHTML = `
              <div class="success">‚úÖ ${data.message}</div>
              <div class="info">
                üç™ <strong>Cookie criado:</strong> XSRF-TOKEN<br>
                üìÑ <strong>Token JSON:</strong> ${data.csrfToken}
              </div>
            `;
            checkTokens(); // Atualiza status dos tokens
          } else {
            status.innerHTML = `<div class="error">‚ùå ${data.error}</div>`;
          }
        } catch (err) {
          status.innerHTML = `<div class="error">‚ùå Erro na requisi√ß√£o: ${err.message}</div>`;
        }
      });

      // 3. ALTERAR SENHA - Com prote√ß√£o CSRF
      document.getElementById('change-password-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const password = document.getElementById('new-password').value;
        const csrfToken = getCsrfToken();
        const status = document.getElementById('change-status');

        if (!csrfToken) {
          status.innerHTML = '<div class="error">‚ùå Token CSRF n√£o encontrado. Fa√ßa login primeiro.</div>';
          return;
        }

        try {
          const response = await fetch('/change-password', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-csrf-token': csrfToken  // üîë PADR√ÉO DOUBLE SUBMIT COOKIE
            },
            credentials: 'include',
            body: JSON.stringify({ password })
          });

          const data = await response.json();
          
          if (response.ok) {
            status.innerHTML = `
              <div class="success">‚úÖ ${data.message}</div>
              <div class="info">
                üîí Token CSRF validado com sucesso!<br>
                ‚úì Cookie e cabe√ßalho coincidiram<br>
                ‚úì Requisi√ß√£o autorizada pelo servidor
              </div>
            `;
          } else {
            status.innerHTML = `<div class="error">‚ùå ${data.error}</div>`;
          }
        } catch (err) {
          status.innerHTML = `<div class="error">‚ùå Erro na requisi√ß√£o: ${err.message}</div>`;
        }
      });

      // 4. ADICIONAR CONTATO - Com prote√ß√£o CSRF
      document.getElementById('contact-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const name = document.getElementById('contact-name').value;
        const phone = document.getElementById('contact-phone').value;
        const csrfToken = getCsrfToken();
        const status = document.getElementById('contact-status');

        if (!csrfToken) {
          status.innerHTML = '<div class="error">‚ùå Token CSRF n√£o encontrado. Fa√ßa login primeiro.</div>';
          return;
        }

        try {
          const response = await fetch('/contact', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-csrf-token': csrfToken  // üîë PADR√ÉO DOUBLE SUBMIT COOKIE
            },
            credentials: 'include',
            body: JSON.stringify({ name, phone })
          });

          const data = await response.json();
          
          if (response.ok) {
            status.innerHTML = `
              <div class="success">‚úÖ ${data.message}</div>
              <div class="info">
                üì± Contato adicionado: ${name} - ${phone}<br>
                üîí Prote√ß√£o CSRF funcionando!
              </div>
            `;
          } else {
            status.innerHTML = `<div class="error">‚ùå ${data.error}</div>`;
          }
        } catch (err) {
          status.innerHTML = `<div class="error">‚ùå Erro na requisi√ß√£o: ${err.message}</div>`;
        }
      });

      // 5. SIMULAR ATAQUES CSRF (sem token)
      async function testAttackPassword() {
        const status = document.getElementById('attack-status');
        
        try {
          const response = await fetch('/change-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ password: 'senhaDoAtacante123' })
            // ‚ö†Ô∏è NOTA: SEM o cabe√ßalho x-csrf-token
          });

          const data = await response.json();
          
          if (response.ok) {
            status.innerHTML = `<div class="error">üö® FALHA DE SEGURAN√áA: Ataque bem-sucedido!</div>`;
          } else {
            status.innerHTML = `
              <div class="success">‚úÖ Ataque de senha bloqueado!</div>
              <div class="info">
                üõ°Ô∏è <strong>Motivo:</strong> ${data.error}<br>
                üîí Token CSRF n√£o fornecido no cabe√ßalho<br>
                ‚úì Prote√ß√£o csrf-csrf funcionando!
              </div>
            `;
          }
        } catch (err) {
          status.innerHTML = `<div class="error">‚ùå Erro na requisi√ß√£o: ${err.message}</div>`;
        }
      }

      async function testAttackContact() {
        const status = document.getElementById('attack-status');
        
        try {
          const response = await fetch('/contact', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ name: 'Atacante', phone: '666666666' })
            // ‚ö†Ô∏è NOTA: SEM o cabe√ßalho x-csrf-token
          });

          const data = await response.json();
          
          if (response.ok) {
            status.innerHTML = `<div class="error">üö® FALHA DE SEGURAN√áA: Ataque bem-sucedido!</div>`;
          } else {
            status.innerHTML = `
              <div class="success">‚úÖ Ataque de contato bloqueado!</div>
              <div class="info">
                üõ°Ô∏è <strong>Motivo:</strong> ${data.error}<br>
                üîí Token CSRF n√£o fornecido no cabe√ßalho<br>
                ‚úì Prote√ß√£o csrf-csrf funcionando!
              </div>
            `;
          }
        } catch (err) {
          status.innerHTML = `<div class="error">‚ùå Erro na requisi√ß√£o: ${err.message}</div>`;
        }
      }

      // Verificar tokens ao carregar a p√°gina
      window.onload = checkTokens;
    </script>
  </body>
</html>
